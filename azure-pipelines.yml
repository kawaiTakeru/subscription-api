trigger: none
pr: none

pool:
  vmImage: windows-2022

variables:
  - name: System.Debug
    value: true
  - name: USE_TARGETED_APPLY
    value: true
  - name: TF_IN_AUTOMATION
    value: true

stages:
- stage: provision_all
  displayName: Provision Subscription + Network (Local state, clean init each step)
  jobs:
  - job: terraform_job
    displayName: Terraform Orchestration
    steps:
      - checkout: self

      - task: TerraformInstaller@1
        displayName: Install Terraform 1.7.5
        inputs:
          terraformVersion: 1.7.5

      # 共通: Terraform ワークディレクトリ
      - task: PowerShell@2
        displayName: Set TF dir variable
        inputs:
          targetType: inline
          script: |
            $tfDir = "$(Build.SourcesDirectory)/terraform"
            if (-not (Test-Path $tfDir)) { throw "Terraform dir not found: $tfDir" }
            Write-Host "##vso[task.setvariable variable=TF_DIR]$tfDir"

      # util: その場で .terraform と .terraform.lock.hcl を掃除
      - task: PowerShell@2
        displayName: Define Clean-TF function
        inputs:
          targetType: inline
          script: |
            function Clean-TF {
              param([string]$Dir)
              $td = Join-Path $Dir ".terraform"
              $lk = Join-Path $Dir ".terraform.lock.hcl"
              if (Test-Path $td) { Write-Host "Remove $td"; Remove-Item -Recurse -Force $td }
              if (Test-Path $lk) { Write-Host "Remove $lk"; Remove-Item -Force $lk }
            }
            Set-Alias -Name CleanTF -Value Clean-TF
            Write-Host "##vso[task.setvariable variable=HasCleanFunc]true"

      # Step0: Subscription（create or reuse）
      # alias 未指定でも命名5変数から自動算出。ARM 反映のみ待機し、az account list の反映待ちは削除。
      - task: AzureCLI@2
        name: step0
        displayName: Step0 - Subscription (create or reuse)
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            Write-Host "[Step0] start. tfDir=$tfDir"

            function Get-TfVar {
              param([string]$Path,[string]$Key)
              if (-not (Test-Path $Path)) { throw "tfvars not found: $Path" }
              $line = Get-Content -LiteralPath $Path | Where-Object { $_ -match "^\s*$Key\s*=" } | Select-Object -First 1
              if (-not $line) { return "" }
              $val = $line -replace "^\s*$Key\s*=\s*", ""
              if ($val -match "#") { $val = ($val -split "#")[0] }
              $val.Trim().Trim('"')
            }
            function Clean-TF { param([string]$Dir)
              $td = Join-Path $Dir ".terraform"; $lk = Join-Path $Dir ".terraform.lock.hcl"
              if (Test-Path $td) { Remove-Item -Recurse -Force $td }
              if (Test-Path $lk) { Remove-Item -Force $lk }
            }
            function Slugify([string]$s) {
              if (-not $s) { return "" }
              $t = $s.Trim().ToLower()
              $t = $t -replace " ", "-" -replace "_", "-" -replace "\.", "-" -replace "/", "-" -replace "\\", "-"
              return $t
            }
            function Build-Base([string]$project,[string]$purpose,[string]$env,[string]$regionCode,[string]$seq) {
              $p1 = Slugify $project
              $p2raw = Slugify $purpose
              $p2 = if ($purpose -eq "検証") { "kensho" } elseif ($p2raw) { $p2raw } else { $p2raw }
              $parts = @($p1,$p2,$env,$regionCode,$seq) | Where-Object { $_ -and $_.Trim() -ne "" }
              return ($parts -join "-")
            }

            $tfvars = Join-Path $tfDir "terraform.tfvars"
            if (-not (Test-Path $tfvars)) { throw "terraform.tfvars missing." }

            $aliasName   = Get-TfVar $tfvars "subscription_alias_name"
            $dispName    = Get-TfVar $tfvars "subscription_display_name"
            $createRaw   = Get-TfVar $tfvars "create_subscription"
            $createFlag  = if ($createRaw -match '^(?i:true|1)$') { $true } else { $false }
            $spokeIdInTf = Get-TfVar $tfvars "spoke_subscription_id"
            $hubSubId    = Get-TfVar $tfvars "hub_subscription_id"
            if (-not $hubSubId) { throw "hub_subscription_id must be set in tfvars." }

            if (-not $aliasName -or -not $dispName) {
              $project = Get-TfVar $tfvars "project_name"
              $purpose = Get-TfVar $tfvars "purpose_name"
              $envId   = Get-TfVar $tfvars "environment_id"
              $rCode   = Get-TfVar $tfvars "region_code"
              $seq     = Get-TfVar $tfvars "sequence"
              $base    = Build-Base $project $purpose $envId $rCode $seq
              if (-not $aliasName -and $base) { $aliasName = "sub-$base" }
              if (-not $dispName  -and $base) { $dispName  = "sub-$base" }
            }
            Write-Host "[Step0] createFlag=$createFlag, spokeIdInTf='$spokeIdInTf', alias='$aliasName'"

            function Get-SubscriptionIdFromAlias([string]$Alias) {
              if (-not $Alias) { return "" }
              foreach ($cmd in @(
                { az account alias show --name $Alias --query "properties.subscriptionId" -o tsv 2>$null },
                { az resource show --ids "/providers/Microsoft.Subscription/aliases/$Alias" --api-version 2021-10-01 --query "properties.subscriptionId" -o tsv 2>$null }
              )) { try { $v = & $cmd; if ($LASTEXITCODE -eq 0 -and $v) { return $v.Trim() } } catch {} }
              return ""
            }

            $finalSubId = ""
            $aliasCreatedNew = "false"

            if (-not $createFlag) {
              if (-not $spokeIdInTf) { throw "create_subscription=false の場合は spoke_subscription_id が必須" }
              $finalSubId = $spokeIdInTf
              Write-Host "[Step0] reuse existing subscription id: $finalSubId"
            } else {
              if ($spokeIdInTf) {
                Write-Warning "[Step0] create_subscription=true ですが spoke_subscription_id が指定済。既存IDを優先します。"
                $finalSubId = $spokeIdInTf
              } else {
                $reuseId = Get-SubscriptionIdFromAlias $aliasName
                if ($reuseId) {
                  $finalSubId = $reuseId
                  Write-Host "[Step0] alias exists. reuse subscription id: $finalSubId"
                } else {
                  if (-not $aliasName) {
                    throw "alias を自動算出できませんでした。tfvars の命名入力（project_name/purpose_name/environment_id/region_code/sequence）を確認してください。"
                  }
                  Write-Host "[Step0] creating alias '$aliasName' (display='$dispName') via Terraform target"
                  Clean-TF $tfDir
                  terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
                  if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step0)" }

                  $vars = @()
                  if ($aliasName) { $vars += "-var"; $vars += "subscription_alias_name=$aliasName" }
                  if ($dispName)  { $vars += "-var"; $vars += "subscription_display_name=$dispName"  }

                  terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve -target azapi_resource.subscription[0] @vars
                  if ($LASTEXITCODE -ne 0) { throw "terraform apply (alias target) failed" }

                  $subOut = terraform -chdir="$tfDir" output -raw subscription_id 2>$null
                  if ($LASTEXITCODE -ne 0 -or -not $subOut) { $subOut = Get-SubscriptionIdFromAlias $aliasName }
                  if (-not $subOut) { throw "Could not resolve subscription id after creation." }
                  $finalSubId = $subOut.Trim()
                  $aliasCreatedNew = "true"
                  Write-Host "[Step0] created subscription id: $finalSubId"

                  terraform -chdir="$tfDir" state show azapi_resource.subscription[0] 1>$null 2>$null
                  if ($LASTEXITCODE -eq 0) {
                    terraform -chdir="$tfDir" state rm azapi_resource.subscription[0] | Out-Null
                    Write-Host "[Step0] removed alias resource from state"
                  }

                  @(
                    'create_subscription = false'
                    'spoke_subscription_id = "' + $finalSubId + '"'
                  ) | Set-Content -Encoding UTF8 (Join-Path $tfDir "override.auto.tfvars")
                  Write-Host "[Step0] wrote override.auto.tfvars to switch to reuse mode"

                  # ARM で購読が取得できるまで待機（最大 ~4分）
                  $ok = $false
                  for($i=1;$i -le 24;$i++){
                    try {
                      az rest --method get --url "https://management.azure.com/subscriptions/$finalSubId?api-version=2020-01-01" | Out-Null
                      $ok=$true
                      Write-Host "[Step0] ARM visibility confirmed"
                      break
                    } catch {
                      Write-Host "[Step0] waiting ARM visibility... ($i/24)"
                      Start-Sleep -Seconds 10
                    }
                  }
                  if (-not $ok) { throw "Subscription not visible in ARM after retries: $finalSubId" }
                }
              }
            }

            if (-not $finalSubId) { throw "final subscription id could not be resolved." }
            Write-Host "##vso[task.setvariable variable=finalSpokeSubscriptionId]$finalSubId"
            Write-Host "##vso[task.setvariable variable=hubSubscriptionId]$hubSubId"
            Write-Host "##vso[task.setvariable variable=aliasCreatedNew]$aliasCreatedNew"
            Write-Host "[Step0] done. finalSpokeSubscriptionId=$finalSubId (aliasCreatedNew=$aliasCreatedNew)"

      # Step1: RG（既存なら import → apply）
      # ここで RG 名の計算を行い、別ステップを増やさずに完結させます
      - task: AzureCLI@2
        displayName: Step1 - Resource Group
        env:
          ARM_USE_AZCLI_AUTH: 'true'
          TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
          TF_VAR_create_subscription: false
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            $subId = "$(finalSpokeSubscriptionId)"
            Write-Host "[Step1] target subscription: $subId"

            # 新サブへの切替を軽くリトライ
            $setOk = $false
            for($i=1;$i -le 12;$i++){
              try { az account set --subscription $subId; $setOk=$true; break } catch { Start-Sleep -Seconds 10 }
            }
            if (-not $setOk) { throw "az account set failed for $subId" }

            function Get-TfVar {
              param([string]$Path,[string]$Key)
              if (-not (Test-Path $Path)) { return "" }
              $line = Get-Content -LiteralPath $Path | Where-Object { $_ -match "^\s*$Key\s*=" } | Select-Object -First 1
              if (-not $line) { return "" }
              $val = $line -replace "^\s*$Key\s*=\s*", ""
              if ($val -match "#") { $val = ($val -split "#")[0] }
              $val.Trim().Trim('"')
            }
            function Slugify([string]$s) {
              if (-not $s) { return "" }
              $t = $s.Trim().ToLower()
              $t = $t -replace " ", "-" -replace "_", "-" -replace "\.", "-" -replace "/", "-" -replace "\\", "-"
              return $t
            }
            function Build-Base([string]$project,[string]$purpose,[string]$env,[string]$regionCode,[string]$seq) {
              $p1 = Slugify $project
              $p2raw = Slugify $purpose
              $p2 = if ($purpose -eq "検証") { "kensho" } elseif ($p2raw) { $p2raw } else { $p2raw }
              $parts = @($p1,$p2,$env,$regionCode,$seq) | Where-Object { $_ -and $_.Trim() -ne "" }
              return ($parts -join "-")
            }

            $tfvars = Join-Path $tfDir "terraform.tfvars"
            $project    = Get-TfVar $tfvars 'project_name'
            $purpose    = Get-TfVar $tfvars 'purpose_name'
            $envId      = Get-TfVar $tfvars 'environment_id'
            $regionCode = Get-TfVar $tfvars 'region_code'
            $seq        = Get-TfVar $tfvars 'sequence'
            $base       = Build-Base $project $purpose $envId $regionCode $seq
            $rgName     = "rg-$base"
            $rgId       = "/subscriptions/$subId/resourceGroups/$rgName"
            Write-Host "[Step1] RG target: $rgName"

            # Clean and init (local backend)
            if (Test-Path (Join-Path $tfDir ".terraform")) { Remove-Item -Recurse -Force (Join-Path $tfDir ".terraform") }
            if (Test-Path (Join-Path $tfDir ".terraform.lock.hcl")) { Remove-Item -Force (Join-Path $tfDir ".terraform.lock.hcl") }
            terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
            if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step1)" }

            # Import RG if exists but not in state
            $exists  = (az group exists -n $rgName)
            $inState = terraform -chdir="$tfDir" state list 2>$null | Select-String -SimpleMatch "azurerm_resource_group.rg"
            if ($exists -eq 'true' -and -not $inState) {
              Write-Host "[Step1] Import RG: $rgId"
              terraform -chdir="$tfDir" import -no-color azurerm_resource_group.rg $rgId
              if ($LASTEXITCODE -ne 0) { throw "terraform import (RG) failed" }
            }

            if ("$(USE_TARGETED_APPLY)" -eq "true") {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve -target azurerm_resource_group.rg
              if ($LASTEXITCODE -ne 0) { Write-Warning "Targeted apply failed; fallback full apply"; terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve }
            } else {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve
            }
            if ($LASTEXITCODE -ne 0) { throw "RG apply failed" }
            Write-Host "[Step1] done."

      # Step2: VNet
      - task: AzureCLI@2
        displayName: Step2 - VNet
        env:
          ARM_USE_AZCLI_AUTH: 'true'
          TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
          TF_VAR_create_subscription: false
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            az account set --subscription "$(finalSpokeSubscriptionId)"

            if (Test-Path (Join-Path $tfDir ".terraform")) { Remove-Item -Recurse -Force (Join-Path $tfDir ".terraform") }
            if (Test-Path (Join-Path $tfDir ".terraform.lock.hcl")) { Remove-Item -Force (Join-Path $tfDir ".terraform.lock.hcl") }
            terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
            if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step2)" }

            if ("$(USE_TARGETED_APPLY)" -eq "true") {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve -target azurerm_virtual_network.vnet
              if ($LASTEXITCODE -ne 0) { Write-Warning "Targeted apply failed; fallback full apply"; terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve }
            } else {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve
            }
            if ($LASTEXITCODE -ne 0) { throw "VNet apply failed" }
            Write-Host "[Step2] done."

      # Step3: Subnet + NSG
      - task: AzureCLI@2
        displayName: Step3 - Subnet + NSG
        env:
          ARM_USE_AZCLI_AUTH: 'true'
          TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
          TF_VAR_create_subscription: false
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            az account set --subscription "$(finalSpokeSubscriptionId)"

            if (Test-Path (Join-Path $tfDir ".terraform")) { Remove-Item -Recurse -Force (Join-Path $tfDir ".terraform") }
            if (Test-Path (Join-Path $tfDir ".terraform.lock.hcl")) { Remove-Item -Force (Join-Path $tfDir ".terraform.lock.hcl") }
            terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
            if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step3)" }

            if ("$(USE_TARGETED_APPLY)" -eq "true") {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve `
                -target azurerm_network_security_group.subnet_nsg `
                -target azurerm_subnet.subnet `
                -target azurerm_subnet_network_security_group_association.subnet_assoc
              if ($LASTEXITCODE -ne 0) { Write-Warning "Targeted apply failed; fallback full apply"; terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve }
            } else {
              terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve
            }
            if ($LASTEXITCODE -ne 0) { throw "Subnet/NSG apply failed" }
            Write-Host "[Step3] done."

      # Step4a: Peering Hub -> Spoke
      - task: AzureCLI@2
        displayName: Step4a - Peering Hub->Spoke
        env:
          ARM_USE_AZCLI_AUTH: 'true'
          TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
          TF_VAR_create_subscription: false
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            $hubSub = "$(hubSubscriptionId)"
            if (-not $hubSub) { throw "hubSubscriptionId variable not set" }
            az account set --subscription $hubSub

            if (Test-Path (Join-Path $tfDir ".terraform")) { Remove-Item -Recurse -Force (Join-Path $tfDir ".terraform") }
            if (Test-Path (Join-Path $tfDir ".terraform.lock.hcl")) { Remove-Item -Force (Join-Path $tfDir ".terraform.lock.hcl") }
            terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
            if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step4a)" }

            terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve
            if ($LASTEXITCODE -ne 0) { throw "Peering Hub->Spoke apply failed" }
            Write-Host "[Step4a] done."

      # Step4b: Peering Spoke -> Hub
      - task: AzureCLI@2
        displayName: Step4b - Peering Spoke->Hub
        env:
          ARM_USE_AZCLI_AUTH: 'true'
          TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
          TF_VAR_create_subscription: false
        inputs:
          azureSubscription: snp-pipeline-api-wif
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $ErrorActionPreference='Stop'
            $tfDir = "$(TF_DIR)"
            az account set --subscription "$(finalSpokeSubscriptionId)"

            if (Test-Path (Join-Path $tfDir ".terraform")) { Remove-Item -Recurse -Force (Join-Path $tfDir ".terraform") }
            if (Test-Path (Join-Path $tfDir ".terraform.lock.hcl")) { Remove-Item -Force (Join-Path $tfDir ".terraform.lock.hcl") }
            terraform -chdir="$tfDir" init -no-color -input=false -backend=false -reconfigure
            if ($LASTEXITCODE -ne 0) { throw "terraform init failed (Step4b)" }

            terraform -chdir="$tfDir" apply -no-color -input=false -auto-approve
            if ($LASTEXITCODE -ne 0) { throw "Peering Spoke->Hub apply failed" }
            Write-Host "[Step4b] done."