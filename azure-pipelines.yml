# subscription-api / azure-pipelines.yml
trigger: none
pr: none

# ← このパイプラインは Default プールで実行（＝ラップトップ）
#   Agent 名を固定したいなら demands を有効化
pool:
  name: Default
  demands:
  - Agent.Name -equals LAPTOP-OEOER8QI   # ← ラップトップのAgent名。不要ならこの2行を消してOK

# 手動実行や将来のFunctionトリガで差し替える入口
parameters:
- name: env
  type: string
  default: dev
- name: location
  type: string
  default: canadacentral

# --- Stage0 入力（既定値）---
- name: subscriptionAliasName
  type: string
  default: "cr_subscription_test_99"
- name: subscriptionDisplayName
  type: string
  default: "CR 検証サブスクリプション 99"
- name: billingAccountName
  type: string
  default: "0ae846b2-3157-5400-bf84-d255f8f82239:d68ce096-f337-4c84-9d39-05562a37bab0_2019-05-31"
- name: billingProfileName
  type: string
  default: "IAMZ-4Q5A-BG7-PGB"
- name: invoiceSectionName
  type: string
  default: "6HB2-O3GL-PJA-PGB"
- name: workload
  type: string
  default: "Production"   # or "DevTest"
- name: managementGroupId
  type: string
  default: "2b72ff53-757a-41b9-aa8f-7056292c626e"  # 例：Tenant Root Group の MG ID
- name: planOnly
  type: boolean
  default: false          # true で plan のみ

stages:
# =========================================================
# Stage0: Subscription
# =========================================================
- stage: stage0_subscription
  displayName: "Stage0 - Create Subscription (AzAPI)"
  jobs:
  - job: run_tf
    displayName: "Terraform apply (subscription)"
    steps:
    # (任意) どのエージェントで走っているか確認
    - powershell: |
        Write-Host "Agent Name: $env:AGENT_NAME"
        Write-Host "Agent OS:   $env:AGENT_OS"
        Write-Host "Agent Pool: $env:AGENT_POOL"
      displayName: "Show Agent Info"

    # 0) Terraform インストール（無ければ）
    - task: Bash@3
      displayName: 'Install Terraform if missing'
      inputs:
        targetType: 'inline'
        script: |
          set -e
          if ! command -v terraform >/dev/null 2>&1; then
            echo "Terraform not found. Installing..."
            sudo apt-get update -y || true
            sudo apt-get install -y gnupg software-properties-common curl || true
            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg || true
            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list || true
            sudo apt-get update -y && sudo apt-get install -y terraform || true
          fi
          terraform -version

    # 1) Azure接続 ＆ Terraform
    - task: AzureCLI@2
      name: tf
      displayName: 'Terraform init/plan/apply (Stage0)'
      inputs:
        azureSubscription: 'snp-pipeline-api'   # ← 作成済みの Service connection
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(Build.SourcesDirectory)/terraform/stage0-subscription
        inlineScript: |
          set -e

          # 入口値の簡易バリデーション（空なら失敗）
          for v in "${{ parameters.billingAccountName }}" "${{ parameters.billingProfileName }}" "${{ parameters.invoiceSectionName }}"; do
            if [ -z "$v" ]; then
              echo "❌ Billing パラメータが空です（billingAccountName / billingProfileName / invoiceSectionName）。"
              exit 1
            fi
          done

          echo "== terraform init =="
          terraform init

          echo "== terraform plan =="
          terraform plan \
            -var "subscription_alias_name=${{ parameters.subscriptionAliasName }}" \
            -var "subscription_display_name=${{ parameters.subscriptionDisplayName }}" \
            -var "billing_account_name=${{ parameters.billingAccountName }}" \
            -var "billing_profile_name=${{ parameters.billingProfileName }}" \
            -var "invoice_section_name=${{ parameters.invoiceSectionName }}" \
            -var "subscription_workload=${{ parameters.workload }}" \
            -var "management_group_id=${{ parameters.managementGroupId }}" \
            -out plan.out

          if [ "${{ parameters.planOnly }}" = "false" ]; then
            echo "== terraform apply =="
            terraform apply -auto-approve plan.out
          else
            echo "Skip apply (planOnly=true)"
          fi

          # 出力を次ステージへ渡す
          SUB_ID=$(terraform output -raw subscription_id 2>/dev/null || true)
          echo "subscriptionId=${SUB_ID}"
          echo "##vso[task.setvariable variable=subscriptionId;isOutput=true]${SUB_ID}"

# =========================================================
# Stage1〜4: ひな型（必要時に実装）
# =========================================================

# Stage1: Resource Group
- stage: stage1_rg
  displayName: "Stage1 - Resource Group"
  dependsOn: stage0_subscription
  variables:
    subscriptionId: $[ stageDependencies.stage0_subscription.run_tf.outputs['tf.subscriptionId'] ]
  jobs:
  - job: placeholder_rg
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'snp-pipeline-api'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          echo "[RG] placeholder"
          echo "SubscriptionId from Stage0: $(subscriptionId)"
          az account set --subscription "$(subscriptionId)"
          az account show --query "{id:id,name:name}" -o tsv

# Stage2: VNet
- stage: stage2_vnet
  displayName: "Stage2 - VNet"
  dependsOn: stage1_rg
  jobs:
  - job: placeholder_vnet
    steps:
    - bash: echo "[VNET] placeholder"

# Stage3: Subnet
- stage: stage3_subnet
  displayName: "Stage3 - Subnet"
  dependsOn: stage2_vnet
  jobs:
  - job: placeholder_subnet
    steps:
    - bash: echo "[SUBNET] placeholder"

# Stage4a: Peering Spoke->Hub
- stage: stage4a_peering_s2h
  displayName: "Stage4a - Peering Spoke->Hub"
  dependsOn: stage3_subnet
  jobs:
  - job: placeholder_peering_s2h
    steps:
    - bash: echo "[PEERING S->H] placeholder"

# Stage4b: Peering Hub->Spoke
- stage: stage4b_peering_h2s
  displayName: "Stage4b - Peering Hub->Spoke"
  dependsOn: stage4a_peering_s2h
  jobs:
  - job: placeholder_peering_h2s
    steps:
    - bash: echo "[PEERING H->S] placeholder"
