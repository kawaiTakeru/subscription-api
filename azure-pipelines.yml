# subscription-api / azure-pipelines.yml
trigger: none
pr: none

pool:
  name: Default

variables:
  - name: System.Debug
    value: 'true'

# パラメータは YAML 側には持たせず、値は terraform.tfvars で管理
stages:
# =========================================================
# Stage0: Subscription (Create via AzAPI)
# =========================================================
- stage: stage0_subscription
  displayName: "Stage0 - Create Subscription (AzAPI)"
  jobs:
  - job: run_tf
    displayName: "Terraform apply (subscription)"
    steps:
    - powershell: |
        Write-Host "Agent Name  : $env:AGENT_NAME"
        Write-Host "Agent OS    : $env:AGENT_OS"
        Write-Host "Agent Ver   : $env:AGENT_VERSION"
      displayName: "Show Agent Info"

    - task: PowerShell@2
      name: tf
      displayName: 'Terraform init/plan/apply (Stage0)'
      env:
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
      inputs:
        targetType: 'inline'
        script: |
          $ErrorActionPreference = 'Stop'
          $stageDir = "$(Build.SourcesDirectory)/terraform/stage0-subscription"
          $tfvars   = "$(Build.SourcesDirectory)/terraform/terraform.tfvars"

          if (-not (Test-Path $tfvars)) {
            Write-Error "terraform.tfvars が見つかりません: $tfvars"
          }

          Push-Location $stageDir

          Write-Host "== terraform init =="
          terraform init

          Write-Host "== terraform plan =="
          terraform plan -var-file="$tfvars" -out plan.out

          Write-Host "== terraform apply =="
          terraform apply -auto-approve plan.out

          # 出力を次ステージへ渡す
          $subId = ""
          try { $subId = terraform output -raw subscription_id } catch {}
          Write-Host "subscriptionId=$subId"
          Write-Host "##vso[task.setvariable variable=subscriptionId;isOutput=true]$subId"

          Pop-Location

# 以降の Stage1〜 は、あなたの RG/VNet/Subnet の PowerShell 版と同じ要領でOK
# 必要になったらこの subscriptionId を参照して az account set するなど実装してください。
