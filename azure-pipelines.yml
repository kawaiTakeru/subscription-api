# 抜粋: Step1〜Step4 だけ置き換え（他はそのまま）
# 重要点:
# - すべて -var-file を付与
# - Step1 冒頭で override.auto.tfvars を削除
# - 初回は USE_TARGETED_APPLY=false 推奨（上に定義されている場合）

# Step1: RG
- task: AzureCLI@2
  displayName: Step1 - Resource Group
  env:
    ARM_USE_AZCLI_AUTH: 'true'
    TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
    TF_VAR_create_subscription: false
  inputs:
    azureSubscription: snp-pipeline-api-wif
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference='Stop'
      az account set --subscription "$(finalSpokeSubscriptionId)"
      $tfDir   = "$(Build.SourcesDirectory)/terraform"
      $varFile = Join-Path $tfDir "terraform.tfvars"
      if (Test-Path (Join-Path $tfDir "override.auto.tfvars")) {
        Write-Host "Found override.auto.tfvars -> remove to avoid overriding tfvars"
        Remove-Item -Force (Join-Path $tfDir "override.auto.tfvars")
      }
      # 念のため今から使う tfvars をログに出す（デバッグ）
      Write-Host "----- terraform.tfvars (begin) -----"
      Get-Content $varFile | Write-Host
      Write-Host "----- terraform.tfvars (end) -----"

      Push-Location $tfDir
      try {
        terraform init -no-color
        terraform apply -no-color -auto-approve -var-file="$varFile"
        # 命名確認（outputs は full apply 後に state に出ます）
        terraform output -no-color base_naming
        terraform output -no-color rg_expected_name
        terraform output -no-color spoke_rg_name
      } finally { Pop-Location }

# Step2: VNet
- task: AzureCLI@2
  displayName: Step2 - VNet
  env:
    ARM_USE_AZCLI_AUTH: 'true'
    TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
    TF_VAR_create_subscription: false
  inputs:
    azureSubscription: snp-pipeline-api-wif
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference='Stop'
      az account set --subscription "$(finalSpokeSubscriptionId)"
      $tfDir   = "$(Build.SourcesDirectory)/terraform"
      $varFile = Join-Path $tfDir "terraform.tfvars"
      Push-Location $tfDir
      try {
        terraform init -no-color
        terraform apply -no-color -auto-approve -var-file="$varFile"
        terraform output -no-color vnet_expected_name
      } finally { Pop-Location }

# Step3: Subnet + NSG
- task: AzureCLI@2
  displayName: Step3 - Subnet + NSG
  env:
    ARM_USE_AZCLI_AUTH: 'true'
    TF_VAR_spoke_subscription_id: $(finalSpokeSubscriptionId)
    TF_VAR_create_subscription: false
  inputs:
    azureSubscription: snp-pipeline-api-wif
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference='Stop'
      az account set --subscription "$(finalSpokeSubscriptionId)"
      $tfDir   = "$(Build.SourcesDirectory)/terraform"
      $varFile = Join-Path $tfDir "terraform.tfvars"
      Push-Location $tfDir
      try {
        terraform init -no-color
        terraform apply -no-color -auto-approve -var-file="$varFile"
      } finally { Pop-Location }

# Step4a/b も同様に -var-file を付与（略）
